version: "3.8"

services:
  # ==================== INFRASTRUCTURE ====================
  postgres:
    image: postgres:15
    container_name: postgres
    restart: always
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    container_name: keycloak
    command: start-dev
    restart: always
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_PORT: 5432
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8081:8080"
    networks:
      - backend
    depends_on:
      postgres:
        condition: service_healthy

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== MICROSERVICES ====================
  eureka-service:
    image: openjdk:21-jdk
    container_name: eureka-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/eureka-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "8761:8761"
    networks:
      - backend
    depends_on:
      - rabbitmq

  api-gateway:
    image: openjdk:21-jdk
    container_name: api-gateway
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/api-gateway-0.0.1-SNAPSHOT.jar"
    ports:
      - "8080:8080"
    networks:
      - backend
    depends_on:
      - eureka-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  config-server:
    image: openjdk:21-jdk
    container_name: config-server
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/config-server-0.0.1-SNAPSHOT.jar"
    ports:
      - "8888:8888"
    networks:
      - backend
    depends_on:
      - eureka-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  # ==================== DATABASES ====================
  user-mysql:
    image: mysql:latest
    container_name: user_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: userdb
      MYSQL_USER: user1
      MYSQL_PASSWORD: pass123
    ports:
      - "3306:3306"
    volumes:
      - user_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  product-mysql:
    image: mysql:latest
    container_name: product_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: productdb
      MYSQL_USER: user2
      MYSQL_PASSWORD: pass123
    ports:
      - "3308:3306"
    volumes:
      - product_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  cart-mysql:
    image: mysql:latest
    container_name: cart_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: cartdb
      MYSQL_USER: user3
      MYSQL_PASSWORD: pass123
    ports:
      - "3309:3306"
    volumes:
      - cart_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
   
  order-mysql:
    image: mysql:latest
    container_name: order_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: orderdb
      MYSQL_USER: user4
      MYSQL_PASSWORD: pass123
    ports:
      - "3303:3306"
    volumes:
      - order_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  inventory-mysql:
    image: mysql:latest
    container_name: inventory_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: inventorydb
      MYSQL_USER: user5
      MYSQL_PASSWORD: pass123
    ports:
      - "3302:3306"
    volumes:
      - inventory_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  payment-mysql:
    image: mysql:latest
    container_name: payment_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: paymentdb
      MYSQL_USER: user6
      MYSQL_PASSWORD: pass123
    ports:
      - "3301:3306"
    volumes:
      - payment_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification-mysql:
    image: mysql:latest
    container_name: notification_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: notificationdb
      MYSQL_USER: user7
      MYSQL_PASSWORD: pass123
    ports:
      - "3300:3306"
    volumes:
      - notification_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-mysql:
    image: mysql:latest
    container_name: auth_mysql_container
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: authdb
      MYSQL_ROOT_HOST: '%'
    ports:
      - "3305:3306"
    volumes:
      - auth_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================== APPLICATION SERVICES ====================
  auth-service:
    image: openjdk:21-jdk
    container_name: auth-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/auth-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9000:9000"
    networks:
      - backend
    depends_on:
      - auth-mysql
      - eureka-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://auth-mysql:3306/authdb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  product-service:
    image: openjdk:21-jdk
    container_name: product-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/product-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9001:9001"
    networks:
      - backend
    depends_on:
      - product-mysql
      - eureka-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://product-mysql:3306/productdb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  order-service:
    image: openjdk:21-jdk
    container_name: order-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/order-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9002:9002"
    networks:
      - backend
    depends_on:
      - order-mysql
      - eureka-service
      - rabbitmq
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://order-mysql:3306/orderdb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq

  payment-service:
    image: openjdk:21-jdk
    container_name: payment-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/payment-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9003:9003"
    networks:
      - backend
    depends_on:
      - payment-mysql
      - eureka-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://payment-mysql:3306/paymentdb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  inventory-service:
    image: openjdk:21-jdk
    container_name: inventory-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/inventory-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9004:9004"
    networks:
      - backend
    depends_on:
      - inventory-mysql
      - eureka-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://inventory-mysql:3306/inventorydb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  user-service:
    image: openjdk:21-jdk
    container_name: user-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/user-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9005:9005"
    networks:
      - backend
    depends_on:
      - user-mysql
      - eureka-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://user-mysql:3306/userdb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  cart-service:
    image: openjdk:21-jdk
    container_name: cart-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/cart-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9006:9006"
    networks:
      - backend
    depends_on:
      - cart-mysql
      - eureka-service
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://cart-mysql:3306/cartdb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

  notification-service:
    image: openjdk:21-jdk
    container_name: notification-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/notification-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9007:9007"
    networks:
      - backend
    depends_on:
      - notification-mysql
      - eureka-service
      - rabbitmq
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://notification-mysql:3306/notificationdb
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/
      - SPRING_RABBITMQ_HOST=rabbitmq

  admin-service:
    image: openjdk:21-jdk
    container_name: admin-service
    restart: always
    working_dir: /app
    command: sh -c "java -jar /app/admin-service-0.0.1-SNAPSHOT.jar"
    ports:
      - "9008:9008"
    networks:
      - backend
    depends_on:
      - eureka-service
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-service:8761/eureka/

networks:
  backend:
    driver: bridge 
      
volumes:
  user_mysql_data:
  product_mysql_data:
  cart_mysql_data:
  order_mysql_data:
  inventory_mysql_data:
  payment_mysql_data:
  notification_mysql_data:
  auth_mysql_data:
